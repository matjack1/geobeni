var GeoMashupLocationEditor,geo_mashup_location_editor;geo_mashup_location_editor={object_id:null,map:null,mapCreated:new mxn.Event("mapCreated",this),loaded:new mxn.Event("loaded",this),markerCreated:new mxn.Event("markerCreated",this),markerSelected:new mxn.Event("markerSelected",this)};jQuery(function(E){var p=geo_mashup_location_editor_settings.geo_mashup_url_path,g=geo_mashup_location_editor_settings.ajax_url,C=E("#geo_mashup_object_id").val(),G=false,a,e,w,A,S,u,v=E("#geo-mashup-inline-help-link"),Q=E("#geo_mashup_add_location"),q=E("#geo_mashup_update_location"),M=E("#geo_mashup_delete_location"),W=E("#geo_mashup_changed"),l=E("#geo_mashup_location_name"),f=E("#geo_mashup_location"),c=E("#geo_mashup_location_id"),t=E("#geo_mashup_geoname"),O=E("#geo_mashup_address"),r=E("#geo_mashup_postal_code"),y=E("#geo_mashup_country_code"),D=E("#geo_mashup_admin_code"),H=E("#geo_mashup_admin_name"),B=E("#geo_mashup_sub_admin_code"),F=E("#geo_mashup_sub_admin_name"),o=E("#geo_mashup_null_fields"),X=E("#geo_mashup_kml_url"),N=E("#geo_mashup_locality_name"),n=E("#geo_mashup_display"),j=n.find(".geo-mashup-info"),m=n.find(".geo-mashup-address"),k=n.find(".geo-mashup-coordinates"),s=E("#geo_mashup_saved_name_ui"),z=E("#geo_mashup_date_ui"),L=E("#geo_mashup_ajax_message"),i=function(Y){this.id=null;this.title="";this.geoname="";this.country_code="";this.admin_code="";this.admin_name="";this.sub_admin_code="";this.sub_admin_name="";this.postal_code="";this.locality_name="";this.address="";this.definedValue=function(aa,Z){if(typeof aa==="undefined"){return Z}else{return aa}};this.subValue=function(ac,ab,Z){var aa;if(typeof Z!=="string"){Z=""}if(typeof ac!=="object"){return Z}if(typeof ab!=="object"){return Z}if(typeof ab.length!=="number"){return Z}aa=ab.shift();if(typeof ac[aa]==="undefined"){return Z}if(ab.length===0){return ac[aa]}return this.subValue(ac[aa],ab,Z)};this.set=function(ab){var aa,Z;if(typeof ab==="string"){if(isNaN(ab)){this.title=ab}else{this.id=ab}}else{if(typeof ab==="number"){this.id=ab}else{if(typeof ab==="object"){if(typeof ab.location_id==="string"){this.id=ab.location_id;this.title=ab.name;this.address=ab.address}else{if(typeof ab.name==="string"){this.id="";this.title=ab.name;this.geoname=ab.name;this.country_code=this.definedValue(ab.countryCode,"");this.admin_code=this.definedValue(ab.adminCode1,"");this.admin_name=this.definedValue(ab.adminName1,"");this.sub_admin_code=this.definedValue(ab.adminCode2,"");this.sub_admin_name=this.definedValue(ab.adminName2,"");this.address=this.title+", "+this.admin_name+", "+this.country_code}else{if(typeof ab.address==="string"){this.title=ab.address;this.address=ab.address;this.country_code=this.subValue(ab,["AddressDetails","Country","CountryNameCode"]);this.admin_code=this.subValue(ab,["AddressDetails","Country","AdministrativeArea","AdministrativeAreaName"]);this.sub_admin_name=this.subValue(ab,["AddressDetails","Country","AdministrativeArea","SubAdministrativeArea","SubAdministrativeAreaName"]);if(this.sub_admin_name){this.locality_name=this.subValue(ab,["AddressDetails","Country","AdministrativeArea","SubAdministrativeArea","Locality","LocalityName"]);this.postal_code=this.subValue(ab,["AddressDetails","Country","AdministrativeArea","SubAdministrativeArea","Locality","PostalCode","PostalCodeNumber"])}else{if(this.admin_code){this.locality_name=this.subValue(ab,["AddressDetails","Country","AdministrativeArea","Locality","LocalityName"]);this.postal_code=this.subValue(ab,["AddressDetails","Country","AdministrativeArea","Locality","PostalCode","PostalCodeNumber"])}}if(this.admin_code.length>20||this.admin_code.indexOf(" ")>=0){this.admin_name=this.admin_code;this.admin_code=""}}else{if(typeof ab.types==="object"){this.title=ab.formatted_address;this.address=ab.formatted_address;for(aa=0;aa<ab.address_components.length;aa+=1){Z=ab.address_components[aa].types.join("|");if(Z.indexOf("country")>=0){this.country_code=ab.address_components[aa].short_name}else{if(Z.indexOf("administrative_area_level_1")>=0){this.admin_code=ab.address_components[aa].short_name;this.admin_name=ab.address_components[aa].long_name}else{if(Z.indexOf("administrative_area_level_2")>=0){this.sub_admin_code=ab.address_components[aa].short_name;this.sub_admin_name=ab.address_components[aa].long_name}else{if(Z.indexOf("locality")>=0){this.locality_name=ab.address_components[aa].short_name}else{if(Z.indexOf("postal_code")>=0){this.postal_code=ab.address_components[aa].short_name}}}}}}if(this.admin_code.length>20||this.admin_code.indexOf(" ")>=0){this.admin_name=this.admin_code;this.admin_code=""}}}}}}}}};if(Y){this.set(Y)}},U=(function(){var aa=E("#geo_mashup_select"),Y=aa.get(0),Z=null,ac=null,ab=function(){var ad,ae;if(Y.selectedIndex>0){ad=Y.options[Y.selectedIndex];ae=ad.value.split("|");if(ae.length>2){ac={location_id:ae[0],name:ad.text,address:ae[3]};Z=new mxn.LatLonPoint(parseFloat(ae[1]),parseFloat(ae[2]));l.val(ad.text)}}};aa.change(function(){ac=Z=null;ab();if(Z){T(Z,ac)}});return{getSelectedID:function(){if(ac){return ac.location_id}else{return null}},getSelectedLatLng:function(){return Z},getSelectedLocation:function(){return ac},selectNone:function(){Y.selectedIndex=0},selectByID:function(ae){var ad;if(!Y.options||!Y.options.length){return false}for(ad=1;ad<Y.options.length;ad+=1){if(ad!==Y.selectedIndex&&Y.options[ad].value.indexOf(ae+"|")===0){Y.selectedIndex=ad;ab();return true}}this.selectNone();return false},selectByText:function(ae){var ad;if(!Y.options||!Y.options.length){return false}if(typeof ae!=="string"){ae=ae.toString()}for(ad=1;ad<Y.options.length;ad+=1){if(ad!==Y.selectedIndex&&Y.options[ad].text===ae){Y.selectedIndex=ad;ab();return true}}this.selectNone();return false}}}()),P=function(){var Y,aa,Z;a={image:p+"/images/mm_20_red.png",shadow:p+"/images/mm_20_shadow.png",iconSize:[12,20],shadowSize:[22,20],iconAnchor:[6,20],infoWindowAnchor:[5,1]};e={image:p+"/images/mm_20_green.png",shadow:p+"/images/mm_20_shadow.png",iconSize:[12,20],shadowSize:[22,20],iconAnchor:[6,20],infoWindowAnchor:[5,1]};Z=E("#geo_mashup_map").empty();u=E('<div id="gm-loading-icon" style="-moz-user-select: none; z-index: 100; position: absolute; left: '+(Z.width()/2)+"px; top: "+(Z.height()/2)+'px;"><img style="border: 0px none ; margin: 0px; padding: 0px; width: 16px; height: 16px; -moz-user-select: none;" src="'+p+'/images/busy_icon.gif"/></a></div>');Z.append(u);geo_mashup_location_editor.map=A=new mxn.Mapstraction(Z.get(0),geo_mashup_location_editor_settings.map_api);A.setOptions({enableDragging:true,enableScrollWheelZoom:true});A.addControls({zoom:"small",map_type:true});geo_mashup_location_editor.showBusyIcon();A.load.addHandler(function(){geo_mashup_location_editor.hideBusyIcon()},A);A.setCenterAndZoom(new mxn.LatLonPoint(0,0),2);if(typeof A.enableGeoMashupExtras==="function"){A.enableGeoMashupExtras()}geo_mashup_location_editor.mapCreated.fire();if(X.val().length>0){geo_mashup_location_editor.loadKml(X.val())}if(f.val().indexOf(",")>0){Y=f.val().split(",");if(Y.length>1){aa=new mxn.LatLonPoint(parseFloat(Y[0]),parseFloat(Y[1]));f.val(aa.toString());T(aa,{location_id:c.val(),name:l.val()})}}A.click.addHandler(b,A);geo_mashup_location_editor.loaded.fire()},d=function(aa,Z){var Y=aa.toString();if((c.val()!==Z.id)||(f.val()!==Y)){if(U.getSelectedID()!==Z.id){U.selectByID(Z.id)}c.val(Z.id||"");f.val(Y);t.val(Z.geoname);O.val(Z.address);r.val(Z.postal_code);y.val(Z.country_code);D.val(Z.admin_code);H.val(Z.admin_name);B.val(Z.sub_admin_code);F.val(Z.sub_admin_name);N.val(Z.locality_name);m.text(Z.address);k.text(aa.toString());j.addClass("ui-state-highlight");geo_mashup_location_editor.setHaveUnsavedChanges()}},h=function(ac,ab){var Y,Z,aa={label:ab.title,icon:a.image,iconSize:e.iconSize,iconShadow:e.iconShadow,iconAnchor:e.iconAnchor,iconShadowSize:e.shadowSize};Y=new mxn.Marker(ac);Y.addData(aa);Y.geo_mashup_location=ab;Y.click.addHandler(function(){V(Y)});if(!w){aa.icon=e.image;aa.draggable=true;Y.addData(aa);w=Y;A.setCenter(ac);d(ac,ab);Z={marker:Y};geo_mashup_location_editor.markerSelected.fire(Z);Y=Z.marker}Z={marker:Y};geo_mashup_location_editor.markerCreated.fire(Z);A.addMarker(Z.marker);if(Z.marker.dragend){Z.marker.dragend.addHandler(function(ae,af,ad){ab.id="";d(ad.location,ab);A.setCenter(ad.location)})}return Z.marker},V=function(Y){if(Y!==w){h(w.location,w.geo_mashup_location);A.removeMarker(w);w=null;h(Y.location,Y.geo_mashup_location);A.removeMarker(Y)}A.setCenter(Y.location)},T=function(aa,Z){var Y=h(aa,new i(Z));V(Y)},b=function(Z,aa,Y){if(Y){J(Y.location.toString())}},x=function(aa,Z){var ab,ad,Y,ac;if(aa&&typeof Z!=="undefined"&&google.maps.GeocoderStatus.OK===Z){for(ab=0;ab<aa.length&&ab<20&&aa[ab].geometry;ab+=1){ad=new mxn.LatLonPoint(aa[ab].geometry.location.lat(),aa[ab].geometry.location.lng());Y=h(ad,new i(aa[ab]))}}else{if(typeof Z==="undefined"&&aa&&200===aa.Status.code&&aa.Placemark&&aa.Placemark.length>0){for(ab=0;ab<aa.Placemark.length&&ab<20&&aa.Placemark[ab];ab+=1){ad=new mxn.LatLonPoint(aa.Placemark[ab].Point.coordinates[1],aa.Placemark[ab].Point.coordinates[0]);Y=h(ad,new i(aa.Placemark[ab]))}}else{ac="http://api.geonames.org/search?type=json&maxRows=20&style=full&callback=?&username="+geo_mashup_location_editor_settings.geonames_username+"&name="+encodeURIComponent(E("#geo_mashup_search").val());jQuery.getJSON(ac,R);geo_mashup_location_editor.showBusyIcon()}}},R=function(ab){var Z,aa,Y;if(ab){for(Z=0;Z<ab.geonames.length&&Z<100&&ab.geonames[Z];Z+=1){aa=new mxn.LatLonPoint(ab.geonames[Z].lat,ab.geonames[Z].lng);Y=h(aa,new i(ab.geonames[Z]))}geo_mashup_location_editor.hideBusyIcon()}},J=function(Y){var ac,Z,ab,ad=null,aa;A.removeAllMarkers();w=null;f.val("");geo_mashup_location_editor.setHaveUnsavedChanges();U.selectNone();if(U.selectByText(Y)){T(U.getSelectedLatLng(),U.getSelectedLocation())}else{if(Y.match(/^[\-\d\.\s]*,[\-\d\.\s]*$/)){ab=Y.split(",");ad=new mxn.LatLonPoint(parseFloat(ab[0]),parseFloat(ab[1]));T(ad)}if(typeof google==="object"&&typeof google.maps==="object"){geo_mashup_location_editor.showBusyIcon();if(typeof google.maps.Geocoder==="function"){ac=new google.maps.Geocoder();aa=A.getBounds();Z={bounds:new google.maps.LatLngBounds(new google.maps.LatLng(aa.getSouthWest().lat,aa.getSouthWest().lng),new google.maps.LatLng(aa.getNorthEast().lat,aa.getNorthEast().lng))};if(ad){Z.latLng=new google.maps.LatLng(ad.lat,ad.lng)}else{Z.address=Y}ac.geocode(Z,x)}else{if(typeof google.maps.ClientGeocoder==="function"){ac=new google.maps.ClientGeocoder();geo_mashup_location_editor.showBusyIcon();aa=A.getBounds();ac.setViewport(new google.maps.LatLngBounds(new google.maps.LatLng(aa.getSouthWest().lat,aa.getSouthWest().lng),new google.maps.LatLng(aa.getNorthEast().lat,aa.getNorthEast().lng)));ac.getLocations(Y,x)}}}else{if(ad){geonames_request_url="http://api.geonames.org/findNearbyJSON?radius=50&style=full&callback=?&username="+geo_mashup_location_editor_settings.geonames_username+"&lat="+ad.lat+"&lng="+ad.lng}else{geonames_request_url="http://api.geonames.org/search?type=json&maxRows=20&style=full&callback=?&username="+geo_mashup_location_editor_settings.geonames_username+"&q="+encodeURIComponent(E("#geo_mashup_search").val())}jQuery.getJSON(geonames_request_url,R);geo_mashup_location_editor.showBusyIcon()}}},I=function(Z,Y){if((Z.keyCode&&Z.keyCode===13)||(Z.which&&Z.which===13)){J(Y);return false}else{return true}},K=function(){G=false;W.val("")};geo_mashup_location_editor.object_id=C;geo_mashup_location_editor.map=A;geo_mashup_location_editor.getSelectedLatLngs=function(){var Y=[];if(w){Y.push(w.location)}return Y};geo_mashup_location_editor.setHaveUnsavedChanges=function(){G=true;W.val("true");if(C>0){q.show()}L.hide()};geo_mashup_location_editor.getHaveUnsavedChanges=function(){return G};geo_mashup_location_editor.loadKml=function(Y){var Z=function(){A.endPan.removeHandler(Z,null);T(A.getCenter(),{location_id:c.val(),name:l.val()})};if(f.val().length===0){A.endPan.addHandler(Z,null)}A.addOverlay(Y,true)};geo_mashup_location_editor.showBusyIcon=function(){u.show()};geo_mashup_location_editor.hideBusyIcon=function(){u.hide()};E(".geo-mashup-js").removeClass("geo-mashup-js");L.hide();E("#geo_mashup_no_js").val("");v.click(function(){E(this).find("span").toggleClass("ui-icon-triangle-1-s").toggleClass("ui-icon-triangle-1-n");E("#geo-mashup-inline-help").slideToggle();return false});E("#geo-mashup-inline-help").hide().click(function(){return v.click()});if(typeof E.datepicker==="object"){E("#geo_mashup_date").datepicker({dateFormat:"M d, yy",changeYear:true,onSelect:function(Y,Z){geo_mashup_location_editor.setHaveUnsavedChanges();z.addClass("ui-state-highlight")}})}else{E("#geo_mashup_date").change(function(){geo_mashup_location_editor.setHaveUnsavedChanges();z.addClass("ui-state-highlight")})}E("#geo_mashup_hour").change(function(){geo_mashup_location_editor.setHaveUnsavedChanges();z.addClass("ui-state-highlight")});E("#geo_mashup_minute").change(function(){geo_mashup_location_editor.setHaveUnsavedChanges();z.addClass("ui-state-highlight")});l.keypress(function(){if(!geo_mashup_location_editor.getHaveUnsavedChanges()){geo_mashup_location_editor.setHaveUnsavedChanges();U.selectNone();s.addClass("ui-state-highlight")}});E("#geo_mashup_search").focus(function(){var Y=E("#geo_mashup_map");this.select();A.resizeTo(Y.width(),Y.height())}).keypress(function(Y){return I(Y,this.value)});P();L.ajaxError(function(aa,Z,Y){if(Y&&Y.data&&Y.data.toString().indexOf("geo_mashup")>=0){L.text(Z.statusText+": "+Z.responseText).show()}});E("#geo_mashup_submit").appendTo("#geo_mashup_ajax_buttons");M.click(function(){var Y;f.val("");Y=E("#geo_mashup_location_editor input").serialize()+"&geo_mashup_delete_location=true&action=geo_mashup_edit";L.hide();E.post(g,Y,function(Z){L.html(Z.status.message).fadeIn("slow");if(200===Z.status.code){K();n.find(".ui-state-highlight").removeClass("ui-state-highlight");A.removeAllMarkers();w=null;U.selectNone();m.text("");k.text("");l.val("");M.hide();q.hide()}},"json");return false});q.click(function(){var Z=E("#geo_mashup_location_editor input").serialize()+"&geo_mashup_update_location=true&action=geo_mashup_edit",aa=(geo_mashup_location_editor_settings.copy_geodata==="true"),Y=E('#postcustom input[value="geo_latitude"]');if(""===l.val()&&s.hasClass("ui-state-highlight")){Z+="&geo_mashup_null_fields=saved_name"}L.hide();E.post(g,Z,function(ab){L.html(ab.status.message).fadeIn("slow");if(200===ab.status.code){if(aa&&Y.length>0){window.location.reload()}K();n.find(".ui-state-highlight").removeClass("ui-state-highlight");q.hide()}},"json");return false});Q.hide();if(!G){q.hide()}if(!C){M.hide()}});GeoMashupLocationEditor=geo_mashup_location_editor;