var GeoMashupLocationEditor,geo_mashup_location_editor;geo_mashup_location_editor={object_id:null,map:null,mapCreated:new mxn.Event("mapCreated",this),loaded:new mxn.Event("loaded",this),markerCreated:new mxn.Event("markerCreated",this),markerSelected:new mxn.Event("markerSelected",this)};jQuery(function($){var geo_mashup_url_path=geo_mashup_location_editor_settings.geo_mashup_url_path,ajax_url=geo_mashup_location_editor_settings.ajax_url,object_id=$("#geo_mashup_object_id").val(),have_unsaved_changes=false,red_icon,green_icon,selected_marker,map,kml,$busy_icon,$inline_help_link=$("#geo-mashup-inline-help-link"),$add_button=$("#geo_mashup_add_location"),$update_button=$("#geo_mashup_update_location"),$delete_button=$("#geo_mashup_delete_location"),$changed_input=$("#geo_mashup_changed"),$location_name_input=$("#geo_mashup_location_name"),$location_input=$("#geo_mashup_location"),$location_id_input=$("#geo_mashup_location_id"),$geoname_input=$("#geo_mashup_geoname"),$address_input=$("#geo_mashup_address"),$postal_code_input=$("#geo_mashup_postal_code"),$country_code_input=$("#geo_mashup_country_code"),$admin_code_input=$("#geo_mashup_admin_code"),$admin_name_input=$("#geo_mashup_admin_name"),$sub_admin_code_input=$("#geo_mashup_sub_admin_code"),$sub_admin_name_input=$("#geo_mashup_sub_admin_name"),$null_fields_input=$("#geo_mashup_null_fields"),$kml_url_input=$("#geo_mashup_kml_url"),$locality_name_input=$("#geo_mashup_locality_name"),$display=$("#geo_mashup_display"),$info_display=$display.find(".geo-mashup-info"),$address_display=$display.find(".geo-mashup-address"),$coordinate_display=$display.find(".geo-mashup-coordinates"),$saved_name_ui=$("#geo_mashup_saved_name_ui"),$date_ui=$("#geo_mashup_date_ui"),$ajax_message=$("#geo_mashup_ajax_message"),GeoAddress=function(init_data){this.id=null;this.title="";this.geoname="";this.country_code="";this.admin_code="";this.admin_name="";this.sub_admin_code="";this.sub_admin_name="";this.postal_code="";this.locality_name="";this.address="";this.definedValue=function(val,alt){if(typeof val==="undefined"){return alt}else{return val}};this.subValue=function(obj,keys,default_value){var key;if(typeof default_value!=="string"){default_value=""}if(typeof obj!=="object"){return default_value}if(typeof keys!=="object"){return default_value}if(typeof keys.length!=="number"){return default_value}key=keys.shift();if(typeof obj[key]==="undefined"){return default_value}if(keys.length===0){return obj[key]}return this.subValue(obj[key],keys,default_value)};this.set=function(data){var i,types;if(typeof data==="string"){if(isNaN(data)){this.title=data}else{this.id=data}}else if(typeof data==="number"){this.id=data}else if(typeof data==="object"){if(typeof data.location_id==="string"){this.id=data.location_id;this.title=data.name;this.address=data.address}else if(typeof data.osm_id==="string"){this.title=data.display_name;this.address=data.display_name;this.country_code=this.definedValue(data.address.country_code,"");this.admin_name=this.definedValue(data.address.state,"");this.sub_admin_name=this.definedValue(data.address.county,"");this.postal_code=this.definedValue(data.address.postcode,"");this.locality_name=this.definedValue(data.address.city,"")}else if(typeof data.types==="object"){this.title=data.formatted_address;this.address=data.formatted_address;for(i=0;i<data.address_components.length;i+=1){types=data.address_components[i].types.join("|");if(types.indexOf("country")>=0){this.country_code=data.address_components[i].short_name}else if(types.indexOf("administrative_area_level_1")>=0){this.admin_code=data.address_components[i].short_name;this.admin_name=data.address_components[i].long_name}else if(types.indexOf("administrative_area_level_2")>=0){this.sub_admin_code=data.address_components[i].short_name;this.sub_admin_name=data.address_components[i].long_name}else if(types.indexOf("locality")>=0){this.locality_name=data.address_components[i].short_name}else if(types.indexOf("postal_code")>=0){this.postal_code=data.address_components[i].short_name}}if(this.admin_code.length>20||this.admin_code.indexOf(" ")>=0){this.admin_name=this.admin_code;this.admin_code=""}}}};if(init_data){this.set(init_data)}},saved_selector=function(){var $select=$("#geo_mashup_select"),select=$select.get(0),selected_latlng=null,selected_location=null,updateSelection=function(){var option,saved_location;if(select.selectedIndex>0){option=select.options[select.selectedIndex];saved_location=option.value.split("|");if(saved_location.length>2){selected_location={location_id:saved_location[0],name:option.text,address:saved_location[3]};selected_latlng=new mxn.LatLonPoint(parseFloat(saved_location[1]),parseFloat(saved_location[2]));$location_name_input.val(option.text)}}};$select.change(function(){selected_location=selected_latlng=null;updateSelection();if(selected_latlng){addSelectedMarker(selected_latlng,selected_location)}});return{getSelectedID:function(){if(selected_location){return selected_location.location_id}else{return null}},getSelectedLatLng:function(){return selected_latlng},getSelectedLocation:function(){return selected_location},selectNone:function(){select.selectedIndex=0},selectByID:function(id){var i;if(!select.options||!select.options.length){return false}for(i=1;i<select.options.length;i+=1){if(i!==select.selectedIndex&&select.options[i].value.indexOf(id+"|")===0){select.selectedIndex=i;updateSelection();return true}}this.selectNone();return false},selectByText:function(text){var i;if(!select.options||!select.options.length){return false}if(typeof text!=="string"){text=text.toString()}for(i=1;i<select.options.length;i+=1){if(i!==select.selectedIndex&&select.options[i].text===text){select.selectedIndex=i;updateSelection();return true}}this.selectNone();return false}}}(),init=function(){var latlng_array,latlng,$container;red_icon={image:geo_mashup_url_path+"/images/mm_20_red.png",shadow:geo_mashup_url_path+"/images/mm_20_shadow.png",iconSize:[12,20],shadowSize:[22,20],iconAnchor:[6,20],infoWindowAnchor:[5,1]};green_icon={image:geo_mashup_url_path+"/images/mm_20_green.png",shadow:geo_mashup_url_path+"/images/mm_20_shadow.png",iconSize:[12,20],shadowSize:[22,20],iconAnchor:[6,20],infoWindowAnchor:[5,1]};$container=$("#geo_mashup_map").empty();if(!$container.is(":visible")){setTimeout(init,100);return}$busy_icon=$('<div id="gm-loading-icon" style="-moz-user-select: none; z-index: 100; position: absolute; left: '+$container.width()/2+"px; top: "+$container.height()/2+'px;">'+'<img style="border: 0px none ; margin: 0px; padding: 0px; width: 16px; height: 16px; -moz-user-select: none;" src="'+geo_mashup_url_path+'/images/busy_icon.gif"/></a></div>');$container.append($busy_icon);geo_mashup_location_editor.map=map=new mxn.Mapstraction($container.get(0),geo_mashup_location_editor_settings.map_api);map.setOptions({enableDragging:true});map.addControls({zoom:"small",map_type:true});geo_mashup_location_editor.showBusyIcon();map.load.addHandler(function(){geo_mashup_location_editor.hideBusyIcon()},map);map.setCenterAndZoom(new mxn.LatLonPoint(0,0),2);if(typeof map.enableGeoMashupExtras==="function"){map.enableGeoMashupExtras()}geo_mashup_location_editor.mapCreated.fire();if($kml_url_input.val().length>0){geo_mashup_location_editor.loadKml($kml_url_input.val())}if($location_input.val().indexOf(",")>0){latlng_array=$location_input.val().split(",");if(latlng_array.length>1){latlng=new mxn.LatLonPoint(parseFloat(latlng_array[0]),parseFloat(latlng_array[1]));$location_input.val(latlng.toString());addSelectedMarker(latlng,{location_id:$location_id_input.val(),name:$location_name_input.val()})}}map.click.addHandler(handleClick,map);geo_mashup_location_editor.loaded.fire()},setInputs=function(latlng,loc){var latlng_string=latlng.toString();if($location_id_input.val()!==loc.id||$location_input.val()!==latlng_string){if(saved_selector.getSelectedID()!==loc.id){saved_selector.selectByID(loc.id)}$location_id_input.val(loc.id||"");$location_input.val(latlng_string);$geoname_input.val(loc.geoname);$address_input.val(loc.address);$postal_code_input.val(loc.postal_code);$country_code_input.val(loc.country_code);$admin_code_input.val(loc.admin_code);$admin_name_input.val(loc.admin_name);$sub_admin_code_input.val(loc.sub_admin_code);$sub_admin_name_input.val(loc.sub_admin_name);$locality_name_input.val(loc.locality_name);$address_display.text(loc.address);$coordinate_display.text(latlng.toString());$info_display.addClass("ui-state-highlight");geo_mashup_location_editor.setHaveUnsavedChanges()}},createMarker=function(latlng,loc){var marker,filter,marker_opts={label:loc.title,icon:red_icon.image,iconSize:green_icon.iconSize,iconShadow:green_icon.iconShadow,iconAnchor:green_icon.iconAnchor,iconShadowSize:green_icon.shadowSize};marker=new mxn.Marker(latlng);marker.addData(marker_opts);marker.geo_mashup_location=loc;marker.click.addHandler(function(){selectMarker(marker)});if(!selected_marker){marker_opts.icon=green_icon.image;marker_opts.draggable=true;marker.addData(marker_opts);selected_marker=marker;map.setCenter(latlng);setInputs(latlng,loc);filter={marker:marker};geo_mashup_location_editor.markerSelected.fire(filter);marker=filter.marker}filter={marker:marker};geo_mashup_location_editor.markerCreated.fire(filter);map.addMarker(filter.marker);if(filter.marker.dragend){filter.marker.dragend.addHandler(function(name,source,args){loc.id="";setInputs(args.location,loc);map.setCenter(args.location)})}return filter.marker},selectMarker=function(marker){if(marker!==selected_marker){createMarker(selected_marker.location,selected_marker.geo_mashup_location);map.removeMarker(selected_marker);selected_marker=null;createMarker(marker.location,marker.geo_mashup_location);map.removeMarker(marker)}map.setCenter(marker.location)},addSelectedMarker=function(latlng,selection){var marker=createMarker(latlng,new GeoAddress(selection));selectMarker(marker)},handleClick=function(click,map,args){if(args){searchForLocations(args.location.toString())}},showAddresses=function(response,status){var i,latlng,marker;if(response&&typeof status!=="undefined"&&google.maps.GeocoderStatus.OK===status){for(i=0;i<response.length&&i<20&&response[i].geometry;i+=1){latlng=new mxn.LatLonPoint(response[i].geometry.location.lat(),response[i].geometry.location.lng());marker=createMarker(latlng,new GeoAddress(response[i]))}}else{searchNominatim($("#geo_mashup_search").val())}},searchNominatim=function(query){var url="https://nominatim.openstreetmap.org/search?format=json&json_callback=?"+"&addressdetails=1&q="+encodeURIComponent(query);jQuery.getJSON(url,showNominatim);geo_mashup_location_editor.showBusyIcon()},reverseSearchNominatim=function(latlng){var url="https://nominatim.openstreetmap.org/reverse?format=json&json_callback=?"+"&addressdetails=1&lat="+encodeURIComponent(latlng.lat)+"&lon="+encodeURIComponent(latlng.lng);jQuery.getJSON(url,showNominatim);geo_mashup_location_editor.showBusyIcon()},showNominatim=function(data){var i;if(data&&data.length){for(i=0;i<data.length&&i<100&&data[i];i+=1){showNominatimResult(data[i])}}else if(data){showNominatimResult(data)}geo_mashup_location_editor.hideBusyIcon()},showNominatimResult=function(result){var latlng=new mxn.LatLonPoint(result.lat,result.lon);createMarker(latlng,new GeoAddress(result))},searchForLocations=function(search_text){var geocoder,request,latlng_array,latlng=null,mxn_map_bounds;map.removeAllMarkers();selected_marker=null;$location_input.val("");geo_mashup_location_editor.setHaveUnsavedChanges();saved_selector.selectNone();if(saved_selector.selectByText(search_text)){addSelectedMarker(saved_selector.getSelectedLatLng(),saved_selector.getSelectedLocation())}else{if(search_text.match(/^[\-\d\.\s]*,[\-\d\.\s]*$/)){latlng_array=search_text.split(",");latlng=new mxn.LatLonPoint(parseFloat(latlng_array[0]),parseFloat(latlng_array[1]));addSelectedMarker(latlng)}if(typeof google==="object"&&typeof google.maps==="object"){geo_mashup_location_editor.showBusyIcon();if(typeof google.maps.Geocoder==="function"){geocoder=new google.maps.Geocoder;mxn_map_bounds=map.getBounds();request={bounds:new google.maps.LatLngBounds(new google.maps.LatLng(mxn_map_bounds.getSouthWest().lat,mxn_map_bounds.getSouthWest().lng),new google.maps.LatLng(mxn_map_bounds.getNorthEast().lat,mxn_map_bounds.getNorthEast().lng))};if(latlng){request.latLng=new google.maps.LatLng(latlng.lat,latlng.lng)}else{request.address=search_text}geocoder.geocode(request,showAddresses)}else if(typeof google.maps.ClientGeocoder==="function"){geocoder=new google.maps.ClientGeocoder;geo_mashup_location_editor.showBusyIcon();mxn_map_bounds=map.getBounds();geocoder.setViewport(new google.maps.LatLngBounds(new google.maps.LatLng(mxn_map_bounds.getSouthWest().lat,mxn_map_bounds.getSouthWest().lng),new google.maps.LatLng(mxn_map_bounds.getNorthEast().lat,mxn_map_bounds.getNorthEast().lng)));geocoder.getLocations(search_text,showAddresses)}}else{latlng?reverseSearchNominatim(latlng):searchNominatim($("#geo_mashup_search").val())}}},searchKey=function(e,search_text){if(e.keyCode&&e.keyCode===13||e.which&&e.which===13){searchForLocations(search_text);return false}else{return true}},clearHaveUnsavedChanges=function(){have_unsaved_changes=false;$changed_input.val("")};geo_mashup_location_editor.object_id=object_id;geo_mashup_location_editor.map=map;geo_mashup_location_editor.getSelectedLatLngs=function(){var latlngs=[];if(selected_marker){latlngs.push(selected_marker.location)}return latlngs};geo_mashup_location_editor.setHaveUnsavedChanges=function(){have_unsaved_changes=true;$changed_input.val("true");if(object_id>0){$update_button.show()}$ajax_message.hide()};geo_mashup_location_editor.getHaveUnsavedChanges=function(){return have_unsaved_changes};geo_mashup_location_editor.loadKml=function(kml_url){var addKmlMarker=function(){map.endPan.removeHandler(addKmlMarker,null);addSelectedMarker(map.getCenter(),{location_id:$location_id_input.val(),name:$location_name_input.val()})};if($location_input.val().length===0){map.endPan.addHandler(addKmlMarker,null)}map.addOverlay(kml_url,true)};geo_mashup_location_editor.showBusyIcon=function(){$busy_icon.show()};geo_mashup_location_editor.hideBusyIcon=function(){$busy_icon.hide()};$(".geo-mashup-js").removeClass("geo-mashup-js");$ajax_message.hide();$("#geo_mashup_no_js").val("");$inline_help_link.click(function(){$(this).find("span").toggleClass("ui-icon-triangle-1-s").toggleClass("ui-icon-triangle-1-n");$("#geo-mashup-inline-help").slideToggle();return false});$("#geo-mashup-inline-help").hide().click(function(){return $inline_help_link.click()});if(typeof $.datepicker==="object"){$("#geo_mashup_date").datepicker({dateFormat:"M d, yy",changeYear:true,onSelect:function(newDate,picker){geo_mashup_location_editor.setHaveUnsavedChanges();$date_ui.addClass("ui-state-highlight")}})}else{$("#geo_mashup_date").change(function(){geo_mashup_location_editor.setHaveUnsavedChanges();$date_ui.addClass("ui-state-highlight")})}$("#geo_mashup_hour").change(function(){geo_mashup_location_editor.setHaveUnsavedChanges();$date_ui.addClass("ui-state-highlight")});$("#geo_mashup_minute").change(function(){geo_mashup_location_editor.setHaveUnsavedChanges();$date_ui.addClass("ui-state-highlight")});$location_name_input.keypress(function(){if(!geo_mashup_location_editor.getHaveUnsavedChanges()){geo_mashup_location_editor.setHaveUnsavedChanges();saved_selector.selectNone();$saved_name_ui.addClass("ui-state-highlight")}});$("#geo_mashup_search").focus(function(){var $container=$("#geo_mashup_map");this.select();map.resizeTo($container.width(),$container.height())}).keyup(function(e){return searchKey(e,this.value)}).keypress(function(e){return searchKey(e,this.value)});init();$ajax_message.ajaxError(function(event,request,settings){if(settings&&settings.data&&settings.data.toString().indexOf("geo_mashup")>=0){$ajax_message.text(request.statusText+": "+request.responseText).show()}});$("#geo_mashup_submit").appendTo("#geo_mashup_ajax_buttons");$delete_button.click(function(){var post_data;$location_input.val("");post_data=$("#geo_mashup_location_editor input").serialize()+"&geo_mashup_delete_location=true&action=geo_mashup_edit";$ajax_message.hide();$.post(ajax_url,post_data,function(data){$ajax_message.html(data.status.message).fadeIn("slow");if(200===data.status.code){clearHaveUnsavedChanges();$display.find(".ui-state-highlight").removeClass("ui-state-highlight");map.removeAllMarkers();selected_marker=null;saved_selector.selectNone();$address_display.text("");$coordinate_display.text("");$location_name_input.val("");$delete_button.hide();$update_button.hide()}},"json");return false});$update_button.click(function(){var post_data=$("#geo_mashup_location_editor input").serialize()+"&geo_mashup_update_location=true&action=geo_mashup_edit",copy_geodata=geo_mashup_location_editor_settings.copy_geodata==="true",$lat_custom_key=$('#postcustom input[value="geo_latitude"]');if(""===$location_name_input.val()&&$saved_name_ui.hasClass("ui-state-highlight")){post_data+="&geo_mashup_null_fields=saved_name"}$ajax_message.hide();$.post(ajax_url,post_data,function(data){$ajax_message.html(data.status.message).fadeIn("slow");if(200===data.status.code){if(copy_geodata&&$lat_custom_key.length>0){window.location.reload()}clearHaveUnsavedChanges();$display.find(".ui-state-highlight").removeClass("ui-state-highlight");$update_button.hide()}},"json");return false});$add_button.hide();if(!have_unsaved_changes){$update_button.hide()}if(!object_id){$delete_button.hide()}});GeoMashupLocationEditor=geo_mashup_location_editor;
